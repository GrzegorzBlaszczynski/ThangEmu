using System.Net.Sockets;
using System.Net;
using System.Text;
using ThangEmu;
using ThangEmu.Packets.Client;


int port = 20000;
IPAddress localAddr = IPAddress.Parse("127.0.0.1");
TcpListener server = new TcpListener(localAddr, port);

server.Start();
Console.WriteLine("Emu is running.");

while (true)
{
    TcpClient client = await server.AcceptTcpClientAsync();
    Console.WriteLine("Client connected.");

    // Obsługa klienta w osobnym zadaniu
    _ = HandleClientAsync(client);
}



static byte[] HexStringToByteArray(string hex)
{
    if (hex.Length % 2 != 0)
        throw new ArgumentException("Wrong byte array structure");

    int length = hex.Length / 2;
    byte[] bytes = new byte[length];

    for (int i = 0; i < length; i++)
    {
        string byteValue = hex.Substring(i * 2, 2);
        bytes[i] = Convert.ToByte(byteValue, 16);
    }

    return bytes;
}



async Task HandleClientAsync(TcpClient client)
{
    byte[] buffer = new byte[1024];
    NetworkStream stream = client.GetStream();

    try
    {
        while (client.Connected)
        {
            int bytesRead = await stream.ReadAsync(buffer, 0, buffer.Length);

            if (bytesRead == 0)
            {
                Console.WriteLine("Disconnected");
                break;
            }

            string receivedData = Encoding.UTF8.GetString(buffer, 0, bytesRead);
            Console.WriteLine($"recived: {bytesRead}");


            PacketEntryRead read = new PacketEntryRead(buffer);

            if (read.opCode == 0x039D)
            {
                LoginPacket login = new LoginPacket(buffer);


                //Character selecting
                byte[] charPacket = HexStringToByteArray("52460d0077ed8ed8f7ec1de6401e2708007700000063ea070077770064ea0c00e7b734072041e6401227a0027600510074007c005100000088ff76007600c3670d4688affec57700000077000000fe137f001c6f6e73127277617b00154f87774438916f2f082f017700000077007700000078004b2d42721874686505486f6f132d3e7b008e2a00007e520000770000005ea00000770000003eee00002e1501001e3c01007700000077000000eeb1010096c81000777c005100000088ff75007600b98ab045986ff8c56f13e44277000000fe1372001673276610770077000000770077000000740039574f7b008e2a00007e520000770000005ea00000770000003eee00002e1501001e3c01007700000077000000eeb1010077000000777b005100000088ff740076002354ba465472f8c53f0efec177000000fe137b001661276116616161166161617700770000007700770000007d0057592f5c3c555a2f2b207b008e2a00007e520000770000005ea00000770000003eee00002e1501001e3c01007700000077000000eeb101007700000077740074007700984177000040770000417700e040770020417700c0407200770077007700c2427700a4427700b6427100a300000077000000ac110000770000007c0076007700770000007700004077000000770000007700000077000000130077007700770077007700a0407700803f77000040770000407700a0407700404077007300770077007c42770060427700ac4276003b00000077000000f3000000770000007c0076001200770000007700004077000000770000007700000077000000770077007700770077007700a0407700803f77000040770000407700a0407700404077007300770077007c42770060427700ac427600770000007700000077000000770000007c0076001200770000007700004077000000770000007700000077000000770077007700770077000000");
                await stream.WriteAsync(charPacket, 0, charPacket.Length);

                Console.WriteLine($"Logged as {login.Login}");
            }


            if (read.opCode == 0x0399)
            {
                Console.WriteLine($"Character selected");

           
                byte[] charPacket = HexStringToByteArray("7e521e007600a8060000770077007f001c6f256412727761cdb002007500");
                await stream.WriteAsync(charPacket, 0, charPacket.Length);

                //d332f7007800750076008e2a00007700830129010000750073005ea000007700840113000000750071003eee00007700850113000000750070002e150100770086012800000075007f001e3c0100770087012800000075009f031dbb04007f0498011400000075009e031dbb04007f0499011400000075009d03b9bb040068049a011400000075009c03b9bb040068049b011400000075009b030109050076009c014b00000075009a03fd0e050076009d017400000075009903969304009c079e01ebffffff750098036fe2040076009f01ebffffff750087036fe2040076009001ebffffff75007c00eeb1010077009101ff8601007714270a00720077000000
                charPacket = HexStringToByteArray("d332c7034b0076009b0301090500760083014b00000076009a03fd0e0500760084017400000076009803929304008b038501ebffffff76008703929304008b038601ebffffff76008603849304007c008701ebffffff76008503849304007c009801ebffffff760080038e2a00009c0799012901000076008f03969304009d079a01ebffffff76008c039693040092079b01ebffffff76008b0374e2040076009c01ebffffff76008a0374e2040076009d01ebffffff7600890357e2040076009e01ebffffff7600880357e2040076009f01ebffffff7600740460090500760090017600000076007704959304009f079101ebffffff7600710462e2040076009201ebffffff7600700462e2040076009301ebffffff76007f048593040072009401ebffffff76007a048293040070009501ebffffff760079048293040070009601ebffffff760067049e93040074009701ebffffff760066049e9304007400a901ebffffff760064049e9304007400aa01ebffffff760063049b9304007300ac01ebffffff760062049b9304007300ad01ebffffff76008403789404000702ae01ebffffff76008303829304007000a101ebffffff76008e03829304007000a201ebffffff76008d0395930400a007a401ebffffff760070002e1501007700a5017700000076007504859304007200a601ebffffff76009e031dbb04007f04a7012800000076009f03b9bb04006804b8011400000076007304839304006900ba01ebffffff76007e04839304006900bb01ebffffff76007b0479e204007600bd01ebffffff7600650479e204007600be01ebffffff76007f001e3c0100a307bf0177000000760071003eee00007700b00177000000760073005ea000007700b1017700000076006c0466e204007600b201ebffffff76006e0466e204007600b301ebffffff7600560469e204007600b401ebffffff76006d0435190100a307b501b5010000760099037f9404007301b701ebffffff76008203939304009007c801ebffffff76008103939304009e07c901ebffffff76007604829304007000ca01ebffffff76007204829304007000cb01ebffffff76007d04929304008b03cc01ebffffff76007c04929304008b03cd01ebffffff7600610436190100ab07ce01830100007600780463e204007600cf01ebffffff76009d031dbb04007f04c1014b000000760076008e2a00007700c201ed00000076007c00eeb101007700c301571c000076009c03b9bb04006804c401150000007600680422bb04007404c501760000007600690422bb04007404c6017600000076006f0422bb04007404c7017600000077d4321f007500130096c810006a0000004b00120084c810007e0000004c0077d5322f0075007600e7133eee000094076900830100007d0000007600f91371e2040076006a00ebffffff180000007714270a00750077000000");
                await stream.WriteAsync(charPacket, 0, charPacket.Length);


        
            }

            if(read.opCode == 0x038c)
            {
                byte[]  charPacket = HexStringToByteArray("1c272400740076007700000069e2040076005703ebffffff770077000000770077000000");
                await stream.WriteAsync(charPacket, 0, charPacket.Length);


                charPacket = HexStringToByteArray("bc3618007e003f00240029003e00230028003d0022001700");
                await stream.WriteAsync(charPacket, 0, charPacket.Length);

                charPacket = HexStringToByteArray("b236790076007c004d0000004b0074007500d751bc45170ec4c577003442770000009e037d003b696e64164d756c12337700770000007700770000007f0033697669196974797b00962e0000865500007700000066a400007700000046f2000036190100264001007700000077000000f6b501007700000077");
                await stream.WriteAsync(charPacket, 0, charPacket.Length);
            }

            string response = $"";
            byte[] responseData = Encoding.UTF8.GetBytes(response);
            await stream.WriteAsync(responseData, 0, responseData.Length);
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error: {ex.Message}");
    }
    finally
    {
        client.Close();
    }
}